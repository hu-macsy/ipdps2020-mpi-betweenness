builds:
  - name: networkit
    git: 'https://github.com/avdgrinten/networkit.git'
    regenerate:
      - args: ['git', 'submodule', 'update', '--init']
    configure:
      - args:
          - 'cmake'
          - '-DCMAKE_INSTALL_PREFIX=@THIS_PREFIX_DIR@'
          - '-DCMAKE_BUILD_TYPE=RelWithDebInfo'
          - '-DNETWORKIT_NODE_STORAGE=u32'
          - '@THIS_CLONE_DIR@'
        environ:
            'CXX': 'g++'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install']

  - name: fabry
    git: 'https://github.com/hu-macsy/fabry.git'
    configure:
      - args:
          - 'meson'
          - '--prefix=@THIS_PREFIX_DIR@'
          - '--buildtype=debugoptimized'
          - '@THIS_CLONE_DIR@'
        environ:
            'CXX': 'mpic++'
            'CXXFLAGS': '-fpermissive'
    compile:
      - args: ['ninja-build']
    install:
      - args: ['ninja-build', 'install']

  - name: dist-kadabra
    git: 'https://github.com/hu-macsy/dist-kadabra.git'
    requires:
      - fabry
      - networkit
    configure:
      - args:
          - 'meson'
          - '--prefix=@THIS_PREFIX_DIR@'
          - '--buildtype=debugoptimized'
          - '@THIS_CLONE_DIR@'
        environ:
            'CXX': 'g++'
            'CXXFLAGS': '-DNETWORKIT_U32_NODES'
    compile:
      - args: ['ninja-build']
    install:
      - args: ['ninja-build', 'install']
      # FIXME: The following is a huge hack!
      - args: ['mkdir', '-p', '@THIS_PREFIX_DIR@/lib64/']
      - args: ['ln', '-sf', '/opt/gcc-9/lib64/libstdc++.so.6', '@THIS_PREFIX_DIR@/lib64/']

revisions:
  - name: initial
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'f49eeecfde56744e9d6677a50c9b7caba3000d76'
        'dist-kadabra': 'db3c0ad9aa66e93f8d187f4b5518b837ef1d12a7'
  - name: shorter-epochs
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'de8986c5289269390280b1d9b7905cbf2108254d'
        'dist-kadabra': 'cf3fb8e1db3d542656170e2cb7228bf5eed26f64'
  - name: initial-reduction
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'ec3fc6069759dbe73906babd2f7d03141ee7ff9f'
        'dist-kadabra': 'eb62764a652bf82d432c6085ac2bf0af86a2fdef'
  - name: initial-logrounds
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'f49eeecfde56744e9d6677a50c9b7caba3000d76'
        'dist-kadabra': '2290d412e758fb74cd3485a6b4f077f2645aac70'
  - name: active
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'f2716e03cc86bbb19819d2030b2c704c4c803c44'
        'dist-kadabra': '0829130d59a1f1de3a2477ef493aee0b9a2350ce'
  # opt: Avoid CC decomposition, useless barriers, 
  - name: opt
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'ec3fc6069759dbe73906babd2f7d03141ee7ff9f'
        'dist-kadabra': 'bd93973c6d4cdacdde62bc893ac8b2763474fc70'
  # optI: Based on opt. Cherry-pick shorter-epochs.
  - name: optI
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'fc771ea642a1ed4c223ba861eecab3deaf9fdc28'
        'dist-kadabra': '6623cb0edb663e26c6fa4490968d6552a9420832'
  # optI-reduction: Based on optI + initial-reduction. Additionally: avoid barrier before reduction.
  - name: optI-reduction
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'd90e39530c8a4fd88d27e78ecffce0b169465227'
        'dist-kadabra': 'dc59bf7ae9761703e9c0007d32f7a68829f2acdd'
  - name: optI-hybrid
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': '5a252d24c619b13fc90f0e2a0804d4b5d89ab505'
        'dist-kadabra': 'aae55ca374ad0654d23953b79109ecedefa0f9ee'
  - name: optI-fastadv
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': '5a252d24c619b13fc90f0e2a0804d4b5d89ab505'
        'dist-kadabra': '68d7b731fa2a5e77ddf78457391c484d2eaca24b'
  - name: all-scores
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': '3eb99eec927e0253c325e9ab0e501a4bd6d7b9d3'
        'dist-kadabra': '79eb2e14a80c0fab85bee669ca692d429a63a561'
  - name: optI-insights
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'd90e39530c8a4fd88d27e78ecffce0b169465227'
        'dist-kadabra': 'c719ef32331e3a2495f2daabf66c614d22824c91'
  - name: optI-blocking
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'b4b2e686e40cbf24d4c1bfbfbf831120c9ed5ee0'
        'dist-kadabra': '5623c9ab7b58bd92497b9a2f967e4e8fe96cb619'
  - name: optI-blockhybrid
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'b4b2e686e40cbf24d4c1bfbfbf831120c9ed5ee0'
        'dist-kadabra': 'f3268c9d5647b2348b89dc90b12d6995d5e52935'
  - name: optB-blocking
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'b4b2e686e40cbf24d4c1bfbfbf831120c9ed5ee0'
        'dist-kadabra': '4c0d5798bf35d0dafb2b0f548accf95ef29c0959'
  - name: optB-fullblocking
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'b4b2e686e40cbf24d4c1bfbfbf831120c9ed5ee0'
        'dist-kadabra': 'dbc26ab30f75d900bcf4045fe45866b8b6cd3fe2'
  - name: optI-blocking-dual
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'b4b2e686e40cbf24d4c1bfbfbf831120c9ed5ee0'
        'dist-kadabra': '22a1d10cc6aaae83bff1ac0ff2cf5407b1ae8054'
  - name: optI-blockhybrid-dual
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'b4b2e686e40cbf24d4c1bfbfbf831120c9ed5ee0'
        'dist-kadabra': 'aed6e766686a0fc1e38a1c2ae999398e517371f1'
  - name: optS
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'de8986c5289269390280b1d9b7905cbf2108254d'
        'dist-kadabra': '129ee54db64e0355747e818aeddfe073e4948787'
  - name: optS-distest
    build_version:
        'networkit': 'd680f815db7a3cd15be4938645731ed5400b3e3a'
        'fabry': 'de8986c5289269390280b1d9b7905cbf2108254d'
        'dist-kadabra': '552f7d5d5ed6b5e820cc6a5392abfda10ee8a503'

instdir: ./instances
instances:
  - repo: local
    set: [main, explore]
    items:
      # Social networks.
      #- twitter.tf.nkbg
      #- friendster.tf.nkbg
      # Road networks.
      - roadNet-CA.tf.nkbg
      - roadNet-PA.tf.nkbg
      # Hyperlink.
      #- dimacs10-uk-2002.tf.nkbg
      #- dimacs10-uk-2007-05.tf.nkbg
      #- wikipedia_link_en.tf.nkbg
  - repo: local
    set: main
    items:
      # Social networks.
      - orkut-links.tf.nkbg
      # Road networks.
      - dimacs9-NE.tf.nkbg
      # Hyperlink.
      - dbpedia-link.tf.nkbg
  - repo: local
    set: scale
    items:
      - hyperbolic-sc23-s1.tf.nkbg
      #- hyperbolic-sc23-s2.tf.nkbg
      #- hyperbolic-sc23-s3.tf.nkbg
      #- hyperbolic-sc24-s1.tf.nkbg
      #- hyperbolic-sc24-s2.tf.nkbg
      #- hyperbolic-sc24-s3.tf.nkbg
      #- hyperbolic-sc25-s1.tf.nkbg
      #- hyperbolic-sc25-s2.tf.nkbg
      #- hyperbolic-sc25-s3.tf.nkbg
      #- hyperbolic-sc26-s1.tf.nkbg
      #- hyperbolic-sc26-s2.tf.nkbg
      #- hyperbolic-sc26-s3.tf.nkbg
      #- hyperbolic-sc27-s1.tf.nkbg
      #- hyperbolic-sc27-s2.tf.nkbg
      #- hyperbolic-sc27-s3.tf.nkbg
      - rmat-sc23-s1.tf.nkbg
      #- rmat-sc23-s2.tf.nkbg
      #- rmat-sc23-s3.tf.nkbg
      #- rmat-sc24-s1.tf.nkbg
      #- rmat-sc24-s2.tf.nkbg
      #- rmat-sc24-s3.tf.nkbg
      #- rmat-sc25-s1.tf.nkbg
      #- rmat-sc25-s2.tf.nkbg
      #- rmat-sc25-s3.tf.nkbg
      #- rmat-sc25-s4.tf.nkbg
      #- rmat-sc26-s1.tf.nkbg
      #- rmat-sc26-s2.tf.nkbg
      #- rmat-sc26-s3.tf.nkbg

experiments:
  - name: n01
    use_builds: [dist-kadabra]
    args: &common_args
      - 'srun'
      - '--mpi=pmi2'
      - 'dist-kadabra'
      - '@INSTANCE@'
    num_nodes: 1
    num_threads: 48
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 24
      OMP_PLACES: 'cores'
  - name: n02
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 2
    num_threads: 48
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 24
      OMP_PLACES: 'cores'
  - name: n04
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 4
    num_threads: 48
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 24
      OMP_PLACES: 'cores'
  - name: n08
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 8
    num_threads: 48
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 24
      OMP_PLACES: 'cores'
  - name: n16
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 16
    num_threads: 48
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 24
      OMP_PLACES: 'cores'

  - name: n01x2
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 1
    procs_per_node: 2
    num_threads: 24
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 12
      OMP_PLACES: 'cores'
  - name: n02x2
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 2
    procs_per_node: 2
    num_threads: 24
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 12
      OMP_PLACES: 'cores'
  - name: n04x2
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 4
    procs_per_node: 2
    num_threads: 24
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 12
      OMP_PLACES: 'cores'
  - name: n08x2
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 8
    procs_per_node: 2
    num_threads: 24
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 12
      OMP_PLACES: 'cores'
  - name: n16x2
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 16
    procs_per_node: 2
    num_threads: 24
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 12
      OMP_PLACES: 'cores'

  - name: t02
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 1
    num_threads: 48
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 2
      OMP_PLACES: 'cores'
  - name: t12
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 1
    num_threads: 48
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 12
      OMP_PLACES: 'cores'
  - name: t24
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 1
    num_threads: 48
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 24
      OMP_PLACES: 'cores'
  - name: t48
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 1
    num_threads: 48
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 48
      OMP_PLACES: 'cores'

  - name: t01x2
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 1
    procs_per_node: 2
    num_threads: 24
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 1
      OMP_PLACES: 'cores'
  - name: t06x2
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 1
    procs_per_node: 2
    num_threads: 24
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 6
      OMP_PLACES: 'cores'
  - name: t12x2
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 1
    procs_per_node: 2
    num_threads: 24
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 12
      OMP_PLACES: 'cores'
  - name: t24x2
    use_builds: [dist-kadabra]
    args: *common_args
    num_nodes: 1
    procs_per_node: 2
    num_threads: 24
    output: 'stdout'
    environ:
      OMP_NUM_THREADS: 24
      OMP_PLACES: 'cores'

matrix:
    include:
      # Special experiments.
      - experiments: [n08x2]
        instsets: [explore]
        revisions: [all-scores]

      # Exploratory experiments.
      #- instsets: [explore]
      #  revisions: [initial]
      - instsets: [explore]
        experiments: [n01, n02, n04, n08, n16]
        revisions: [shorter-epochs, initial-reduction, opt, optI-reduction]
        # Dropped: initial-logrounds
      #- instsets: [explore]
      #  experiments: [n01, n02, n04, n08]
      #  instsets: [explore]
      #  revisions: []
         # Dropped: active
      - instsets: [explore]
        experiments: [n01x2, n02x2, n04x2, n08x2]
        instsets: [explore]
        revisions: [optI-insights]
        # Dropped: optI-fastadv

      # Real-world running time experiments
      # Shared-memory baseline.
      - instsets: [main]
        experiments: [n01]
        revisions: [opt, optI-insights]
      # New MPI algorithms.
      - instsets: [main]
        experiments: [n01x2, n02x2, n04x2, n08x2, n16x2]
        revisions: [optI-reduction, optI-hybrid, optI-blocking, optI-blockhybrid, optB-blocking, optB-fullblocking, optI-blocking-dual, optI-blockhybrid-dual, optS, optS-distest]

      # Scaling experiments.
      - instsets: [scale]
        experiments: [n16x2]
        revisions: [optI-reduction]
        # Dropped: optI-blocking

      # NUMA experiments.
      #- instsets: [explore]
      #  experiments: [t02, t12, t24, t48, t01x2, t06x2, t12x2, t24x2]
      #  revisions: [optI]
